# 期限つきToDoリスト
#### Video Demo:  <URL https://youtu.be/CxqtlL458mU>
#### Description:
　繰り返しの期限付きToDoリストを作りました。
　会員登録、ログイン、ログアウトが可能です。
　ログイン後のホーム画面では、ToDoが期限の近い順に一覧となり、タイトル・期限・期限までの残りの日数が表示されます。また、期限を過ぎたToDoの行は背景色が赤くなります。
 各ページでToDoの追加、削除、更新が可能です。追加ではToDoのタイトル、間隔、最後に行った日を入力します。間隔は月、週、日から選択できます。削除では既にあるToDoをタイトルから選択し、削除することができます。更新では既にあるToDoをタイトルから選択し、最後に行った日を当日に更新することができます。
更新では、別の日への更新を可能にすることも考えましたが、当日のみの方が手順が少ないため当日になるようにしました。
　layout.htmlは基本のレイアウトで、他のすべてのHTMLに継承されます。add.htmlは追加で、ToDoのタイトルのテキスト入力フォームと間隔のテキスト入力フォーム、間隔の単位のセレクトボックス、最後に行った日の日付入力フォーム、送信ボタンがあります。delete.htmlは削除で、ToDoのセレクトボックスと送信ボタンがあります。update.htmlは更新で、ToDoのセレクトボックスと送信ボタンがあります。login.htmlはログイン、register.htmlは新規登録、apology.htmlはエラー表示で、apology関数から送られたtopとbottomを表示します。
　todo.dbにはusersとtodosの2つのテーブルがあります。usersにはユーザーidとパスワードのハッシュ、todosにはid、ユーザーid、タイトル、最後に行った日、期限、間隔(月、週、日)が含まれます。
styles.cssでは、全体のフォント、navbar-brandのフォントサイズ、テーブルのスタイルを指定しています。
　app.pyについて説明します。todosのそれぞれのカラムの物理名は、idはid、ユーザーidはuser_id、タイトルはtodo、最後に行った日はdid、期限はwill、月の間隔はinterval_month、週の間隔はinterval_week、日の間隔はinterval_dayです。
　login_requiredでは、ログインしていない場合ログインページに送ります。
　apology関数は、２つの引数（エラーメッセージとエラーコード）を取り、apology.htmlにこの二つを送り、apology.htmlを表示します。
　home関数は、urlパラメータがない（/のみ）場合です。データベースからタイトルと期限を取得し、willの早い順に並べます。現在時刻を取得し、残日数のリストを宣言します。for文でデータベースから取得したデータに1行ずつ以下の処理を行います。期限を文字列型からdatetime型に変換します。期限から現在時刻を引き、この差の日を残日数のリストの最後に追加します。期限を再度datetime型から文字列型に変換し、時刻を捨て日付のみにします。最後にデータベースから取得したタイトルと期限、残日数のリストを送り、home.htmlを表示します。
　add関数は、urlパラメータが/addの場合です。リクエストメゾットがGETの場合、add.htmlを表示します。リクエストメゾットがPOSTの場合、以下の処理を行います。タイトル、間隔、最後に行った日に入力がない場合、エラーを返します。同じタイトル、同じユーザーidのtodoがデータベースに既にある場合もエラーを返します。変数interval_month、interval_week、interval_dayを0に初期化します。間隔の単位がヶ月の場合、間隔をinterval_monthに入れ、間隔の単位が週の場合、間隔をinterval_weekに入れ、間隔の単位が日の場合、間隔をinterval_dayに入れます。最後に行った日を文字列型からdatetime型に変換します。didにinterval_monthの月、interval_weekの週、interval_dayの日を足します。データベースのテーブルtodosにユーザーid、タイトル、 interval_month、interval_week、interval_day、最後に行った日、期限を挿入します。画面に「追加しました」のflashメッセージを表示し、ホームに戻します。
　delete関数はurlパラメータが/deleteの場合です。 リクエストメゾットがGETの場合、データベースのテーブルtodosからログイン中のユーザーidのタイトルを取得して送り、delete.htmlを表示します。リクエストメゾットがPOSTの場合、データベースのテーブルtodos入力されたタイトルかつログイン中のユーザーidの行を削除し、画面に「追加しました」のflashメッセージを表示してホームに戻します。
　update関数はurlパラメータが/updateの場合です。 リクエストメゾットがGETの場合、データベースのテーブルtodosからログイン中のユーザーidのタイトルを取得して送り、update.htmlを表示します。リクエストメゾットがPOSTの場合、以下の処理を行います。まず現在時刻を取得します。選択されたタイトルとログイン中のユーザーネームの月の間隔、週の間隔、日の間隔を取得します。現在時刻に取得した間隔をそれぞれ足します。データベースのテーブルtodosの最後に行った日を現在時刻、期限を先ほど足したものに更新します。画面に「更新しました」のflashメッセージを表示し、ホームに戻します。
　login関数はurlパラメータが/loginの場合です。まずセッションのユーザーidをクリアします。リクエストメゾットがPOSTの場合、以下の処理を行います。ユーザーネームまたはパスワードが入力されていない場合、エラーを返します。データベースのテーブルusersから入力されたユーザーネームのデータを取り出します。このデータから、ユーザーネームとパスワードが正しいか確認し、正しくない場合エラーを返します。セッションにユーザーidを保存します。画面に「ログインしました」のflashメッセージを表示し、ホームに戻します。
　logout関数はurlパラメータが/logoutの場合です。セッションのユーザーidをクリアし、ホームに戻します。
　register関数はurlパラメータが/registerの場合です。リクエストメゾットがGETの場合、register.htmlを表示します。リクエストメゾットがPOSTの場合、以下の処理を行います。ユーザーネーム、パスワードに入力がない場合、パスワードと確認のパスワードが一致しない場合、エラーを返します。同じユーザーネームがデータベースのテーブルusersに既にある場合もエラーを返します。データベースのテーブルusersに入力されたユーザーネーム、ハッシュ化したパスワードを挿入します。画面に「登録が完了しました」のflashメッセージを表示し、ログインページに送ります。